# Contract System

Contracts define features as human-readable markdown files with YAML front-matter. They serve as the single source of truth for all features.

## ðŸ“š Documentation

- **[Complete Contract Guide](../docs/contracts.md)** - Full workflow and best practices
- **[Vibe Lane Guide](../docs/vibe-lane.md)** - Exploration-first development

## ðŸŽ¯ Implemented Contracts

| Contract ID | Title | Status | Description |
|------------|-------|--------|-------------|
| APC-CORE | Contract schema and validator | achieved | Core contract system with YAML validation |
| APC-GUARD | Pre-commit scope guard | achieved | WARN/BLOCK modes for development |
| APC-ENFORCER | CI contract enforcer | achieved | GitHub Actions workflow for PRs |
| APC-PR | PR template and policy | achieved | Standardized PR process |
| APC-VIBE | Vibe lane exploration | achieved | Exploration workflow with auto-promotion |
| APC-AGENT | Agent wrapper | achieved | Contract-bound AI agent |
| APC-BUDGETS | Performance budgets | achieved | Budget and telemetry checks |
| APC-DOCS | Documentation | achieved | This documentation |

## Format

Each contract lives at `contracts/<ID>.contract.md` with required YAML front-matter:

```yaml
---
id: FEATURE-ID
title: Human readable title
status: planned | in_progress | achieved | maintained | deprecated
owner: owner-name
version: 1.0.0
allowed_globs:
  - src/feature/**
  - tests/feature/**
forbidden_globs:  # optional
  - src/legacy/**
budgets:  # optional (new!)
  latency_ms_p50: 200
  bundle_kb_delta_max: 50
telemetry:  # optional (new!)
  events:
    - "event.name"
acceptance_criteria:
  - id: AC-1
    must: MUST do something specific
    text: Detailed description of the criterion
    tests:
      - test/feature.test.js
    suggested: true  # optional: indicates auto-generated by heuristics
checkpoints:  # optional
  - id: CP-1
    date: 2024-01-01
    status: completed
    notes: Initial implementation done
---

# Feature Name

Full markdown documentation of the feature...
```

## Quick Reference

### Required Fields
- `id` - Unique identifier
- `title` - Human-readable name
- `status` - Current state
- `owner` - Responsible party
- `version` - Semantic version
- `allowed_globs` - Permitted file patterns
- `acceptance_criteria` - Requirements with tests

### Optional Fields
- `forbidden_globs` - Blocked file patterns
- `budgets` - Performance constraints
- `telemetry` - Required event tracking
- `checkpoints` - Progress milestones

## Promotion Heuristics

The `dp vibe promote` command uses intelligent heuristics to suggest acceptance criteria based on code changes:

### Pattern Detection

1. **Persistence Patterns**: Detects usage of:
   - localStorage/sessionStorage
   - IndexedDB
   - Cookies
   - Redux-persist
   - Suggests criterion: "State persists across reloads"

2. **Telemetry Patterns**: Detects calls to:
   - analytics.track()
   - posthog.capture()
   - amplitude.logEvent()
   - mixpanel.track()
   - gtag('event')
   - Extracts event names and adds to `telemetry.events`
   - Suggests criterion: "Emits <event> on <action>"

3. **API Changes**: Detects modifications in:
   - src/api/** files
   - Route definitions
   - HTTP method usage
   - Suggests criterion: "API endpoints return expected status codes and response schemas"

4. **Sorting Logic**: Detects:
   - .sort() calls
   - orderBy usage
   - SQL ORDER BY
   - Suggests criterion: "Existing sort order semantics preserved"

### Suggested Criteria

Criteria added by heuristics have `suggested: true` flag. They are appended to existing criteria without removing manual ones. Test scaffolds are auto-generated with TODO placeholders for implementation.

## Example Contract

```yaml
---
id: AUTH-CORE
title: Authentication Core Module
status: in_progress
owner: team-auth
version: 1.0.0
allowed_globs:
  - src/auth/**
  - tests/auth/**
  - contracts/auth/**
forbidden_globs:
  - src/legacy/auth/**
budgets:
  latency_ms_p50: 100
  bundle_kb_delta_max: 20
telemetry:
  events:
    - "auth.login"
    - "auth.logout"
    - "auth.refresh"
acceptance_criteria:
  - id: AC-AUTH-1
    must: MUST validate JWT tokens
    text: System validates incoming JWT tokens and rejects invalid/expired ones
    tests:
      - tests/auth/jwt.test.js
  - id: AC-AUTH-2
    must: MUST support refresh tokens
    text: System provides refresh token mechanism with 7-day expiry
    tests:
      - tests/auth/refresh.test.js
checkpoints:
  - id: CP-1
    date: 2024-01-15
    status: completed
    notes: JWT validation implemented
---

# Authentication Core Module

This contract defines the authentication system requirements...
```

## Validation

Run validation with:
```bash
npm run contracts:validate
```

This will:
1. Validate all contract files for required fields
2. Check for duplicate IDs
3. Validate budgets and telemetry if present
4. Ensure acceptance criteria are not empty
5. Compute and store Contract-Hash in `.softsensor/<ID>.hash`

## Contract-Hash

The Contract-Hash is computed as:
```javascript
sha256(JSON.stringify({
  id,
  allowed_globs,
  acceptance_criteria,
  budgets,     // included if defined
  telemetry    // included if defined
}))
```

Stored in `.softsensor/<ID>.hash`, this provides a stable fingerprint of the contract's core requirements.

## Workflow Commands

### Create Contract from Exploration
```bash
dp vibe start "new feature"   # Start exploring
# ... work ...
dp vibe promote               # Generate contract
```

### Validate Contracts
```bash
npm run contracts:validate    # Check all contracts
```

### Check Scope (Pre-commit)
```bash
npm run hooks:install         # Install pre-commit hook
# Automatically checks on commit
```

### Enforce in CI
```bash
# Automatic on PR with Contract-Id trailer
```

### Check Budgets
```bash
CONTRACT_IDS="AUTH-CORE" npm run budgets:check
```

### Use with Agent
```bash
# Set active task
echo '{"contract_id":"AUTH-CORE"}' > .softsensor/active-task.json
npm run agent:task "implement refresh token logic"
```